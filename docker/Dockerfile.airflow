FROM apache/airflow:2.9.2-python3.11

USER root

# Install system dependencies
RUN apt-get update && apt-get install -y \
    git gcc g++ libpq-dev curl \
    && rm -rf /var/lib/apt/lists/*

USER airflow
WORKDIR /opt/airflow

COPY orchestrator/requirements.txt .

# Upgrade pip first
RUN pip install --upgrade pip setuptools wheel

# Install packages one by one to avoid conflicts
RUN pip install --default-timeout=300 --no-cache-dir \
    boto3==1.34.131 \
    google-api-python-client==2.147.0 \
    prometheus-client==0.20.0

# Install langsmith (has many dependencies)
RUN pip install --default-timeout=300 --no-cache-dir \
    langsmith==0.1.77

# Install DVC separately (it has complex dependencies)
RUN pip install --default-timeout=300 --no-cache-dir \
    dvc==3.51.2

# Install Airflow providers
RUN pip install --default-timeout=300 --no-cache-dir \
    apache-airflow-providers-amazon==8.27.0 \
    apache-airflow-providers-http==4.12.0 \
    apache-airflow-providers-cncf-kubernetes==8.4.1

COPY orchestrator/dags /opt/airflow/dags
COPY orchestrator/plugins /opt/airflow/plugins
COPY orchestrator/airflow_config /opt/airflow/airflow_config

ENV AIRFLOW__CORE__LOAD_EXAMPLES=False
ENV AIRFLOW__CORE__EXECUTOR=LocalExecutor
ENV AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=sqlite:////opt/airflow/airflow.db

EXPOSE 8080

CMD ["/bin/bash", "-c", "\
    airflow db init && \
    airflow users create \
        --username admin \
        --password admin \
        --firstname AI \
        --lastname Ops \
        --role Admin \
        --email admin@example.com || true && \
    airflow scheduler & \
    airflow webserver \
"]
