FROM python:3.11-slim

WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y \
    git gcc g++ wget curl build-essential \
    && rm -rf /var/lib/apt/lists/*

# Upgrade pip
RUN pip install --upgrade pip setuptools wheel

# Install PyTorch first (largest dependency)
RUN pip install --default-timeout=500 --no-cache-dir \
    torch==2.3.1 \
    torchvision==0.18.1 \
    torchaudio==2.3.1

# Copy requirements
COPY requirements.txt .

# Install transformers and related packages
RUN pip install --default-timeout=500 --no-cache-dir \
    transformers==4.41.0 \
    accelerate==0.31.0 \
    sentence-transformers==3.0.1 \
    faiss-cpu==1.8.0 \
    rank-bm25==0.2.2 \
    scikit-learn==1.5.0 \
    datasets==2.19.2

# Install LangChain ecosystem
RUN pip install --default-timeout=500 --no-cache-dir \
    langchain==0.2.5 \
    langgraph==0.0.69 \
    langchain-community==0.2.5 \
    langsmith==0.1.77 \
    huggingface-hub==0.23.4 \
    ragas==0.1.9

# Install MLOps tools
RUN pip install --default-timeout=500 --no-cache-dir \
    dvc==3.51.2 \
    dvc-s3==3.2.0 \
    mlflow==2.13.2 \
    celery==5.4.0 \
    redis==5.0.6 \
    kombu==5.3.7 \
    boto3==1.34.131 \
    botocore==1.34.131 \
    aioaws==0.13 \
    aiohttp==3.9.5 \
    pydantic==2.7.4

# Install remaining dependencies
RUN pip install --default-timeout=500 --no-cache-dir -r requirements.txt

# Copy application code
COPY src ./src
COPY models ./models
COPY data ./data

ENV PYTHONUNBUFFERED=1

CMD ["python", "src/training/train_lora.py"]
